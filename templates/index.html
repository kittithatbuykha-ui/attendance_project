<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ AI - ‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen">
    <div class="max-w-md mx-auto p-4">
        <div class="bg-blue-600 p-4 rounded-t-2xl shadow-lg text-center">
            <h1 class="text-xl font-bold">{{ info.subject }}</h1>
            <p class="text-sm opacity-80">{{ info.room }} | {{ info.teacher }}</p>
        </div>

        <div class="bg-gray-800 p-2 relative shadow-2xl">
            <video id="video" class="w-full rounded-lg bg-black" autoplay playsinline></video>
            <canvas id="canvas" class="hidden" width="640" height="480"></canvas>
            <div class="absolute inset-0 border-2 border-blue-400 opacity-30 pointer-events-none m-4 rounded"></div>
        </div>

        <div id="status" class="bg-gray-800 p-6 rounded-b-2xl border-t border-gray-700 text-center">
            <div id="result-name" class="text-3xl font-bold text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</div>
            <div id="result-time" class="text-sm text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const nameDiv = document.getElementById('result-name');
        const timeDiv = document.getElementById('result-time');
        let lastScannedName = ""; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏π‡∏î‡∏ã‡πâ‡∏≥‡∏£‡∏±‡∏ß‡πÜ

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏π‡∏î‡∏ä‡∏∑‡πà‡∏≠
        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'th-TH'; // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            window.speechSynthesis.speak(msg);
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
            .then(stream => { video.srcObject = stream; })
            .catch(err => { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á"); });

        async function scanFace() {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob, 'frame.jpg');

                try {
                    const response = await fetch('/scan', { method: 'POST', body: formData });
                    const data = await response.json();
                    
                    if (data.name !== "Unknown") {
                        nameDiv.innerText = "‚úÖ ‡∏û‡∏ö: " + data.name;
                        nameDiv.className = "text-3xl font-bold text-green-400 animate-bounce";
                        timeDiv.innerText = "‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + data.time;

                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î‡∏ä‡∏∑‡πà‡∏≠
                        if (lastScannedName !== data.name) {
                            speak("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö " + data.name + " ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
                            lastScannedName = data.name;
                            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                            setTimeout(() => { lastScannedName = ""; }, 5000);
                        }
                    } else {
                        nameDiv.innerText = "üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...";
                        nameDiv.className = "text-3xl font-bold text-blue-400";
                    }
                } catch (e) { console.error(e); }
            }, 'image/jpeg');
        }
        setInterval(scanFace, 3000); // ‡∏™‡πÅ‡∏Å‡∏ô‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    </script>
</body>
</html>
